<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Positive Drug Tests – Treemap of Positive Tests by State</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    .chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
      max-width: 1000px;
      width: 100%;
      margin: 3rem auto;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    #treemap {
      width: 100%;
      height: 700px;
      display: block;
    }
    #treemap svg { width: 100%; height: 100%; }
    .node { font-size: 12px; pointer-events: none; }
    .node rect { stroke: #fff; }
    .node text { pointer-events: none; fill: #fff; font-weight: bold; }
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 6px 10px;
      border-radius: 5px;
      font-size: 13px;
      pointer-events: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="logo"><img src="images/logo.png" alt="Australian Government"/></div>
      <h1>Police Enforcement</h1>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="drugtests.html" class="active">Drugs on the Road</a></li>
        <li><a href="mobile-phone.html">Mobile phone</a></li>
        <li><a href="speeding.html">Speeding</a></li>
        <li><a href="seatbelts.html">Seatbelts</a></li>
        <li><a href="unlicensed-driving.html">Unlicensed driving</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="tab-content active">
      <h2 style="text-align:center;">Treemap of Positive Drug Tests by State (2008–2023)</h2>
      <div class="chart-container">
        <div id="treemap"></div>
      </div>
    </section>
  </main>

  <footer>
    <p>© 2025 Australian Government Department of Infrastructure, Transport, Regional Development, Communications and the Arts</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const container = d3.select('#treemap');
      const width = container.node().offsetWidth;
      const height = container.node().offsetHeight;

      container.selectAll('*').remove();
      const svg = container.append('svg')
        .attr('width', width)
        .attr('height', height);

      const tooltip = d3.select('body').append('div')
        .attr('class', 'tooltip')
        .style('opacity', 0);

      d3.csv('database/drug_police_enforcement_2023_positive_drug_tests_2024-09-20.csv').then(data => {
        data.forEach(d => {
          d.count = +d['COUNT'].replace(/[^0-9.-]+/g, '') || 0;
          d.state = d['JURISDICTION'] || 'Unknown';
        });

        const testsByState = Array.from(
          d3.rollup(data, v => d3.sum(v, d => d.count), d => d.state),
          ([state, total]) => ({ state, total })
        ).filter(d => d.state);

        const states = testsByState.map(d => d.state);
        const color = d3.scaleOrdinal()
          .domain(states)
          .range(d3.schemeCategory10);

        const root = d3.hierarchy({ children: testsByState })
          .sum(d => d.total)
          .sort((a, b) => b.value - a.value);

        d3.treemap()
          .size([width, height])
          .paddingInner(2)(root);

        const nodes = svg.selectAll('g.node')
          .data(root.leaves())
          .join('g')
            .attr('class', 'node')
            .attr('transform', d => `translate(${d.x0},${d.y0})`);

        nodes.append('rect')
          .attr('width', d => d.x1 - d.x0)
          .attr('height', d => d.y1 - d.y0)
          .attr('fill', d => color(d.data.state));

        // display state and total inside each box
        nodes.append('text')
          .attr('x', 6)
          .attr('y', 18)
          .text(d => `${d.data.state}: ${d3.format(',')(d.data.total)}`)
          .call(wrap, d => d.x1 - d.x0 - 12);

        nodes.on('mouseover', (event, d) => {
            d3.select(event.currentTarget).select('rect')
              .attr('stroke', '#000')
              .attr('stroke-width', 1.5);
            tooltip.transition().duration(200).style('opacity', 0.9);
            tooltip.html(`<strong>${d.data.state}</strong><br/>Positive Tests: ${d3.format(',')(d.value)}`)
              .style('left', `${event.pageX + 10}px`)
              .style('top', `${event.pageY - 28}px`);
          })
          .on('mouseout', (event) => {
            d3.select(event.currentTarget).select('rect').attr('stroke', null);
            tooltip.transition().duration(400).style('opacity', 0);
          });

        // helper: wrap text to fit within box
        function wrap(textSelection, getWidth) {
          textSelection.each(function(d) {
            const text = d3.select(this);
            const width = getWidth(d);
            const words = text.text().split(/\s+/).reverse();
            let word, line = [], lineNumber = 0;
            const lineHeight = 1.1; // ems
            const y = text.attr('y');
            let tspan = text.text(null).append('tspan').attr('x', 6).attr('y', y);
            while (word = words.pop()) {
              line.push(word);
              tspan.text(line.join(' '));
              if (tspan.node().getComputedTextLength() > width) {
                line.pop();
                tspan.text(line.join(' '));
                line = [word];
                tspan = text.append('tspan')
                  .attr('x', 6)
                  .attr('y', y)
                  .attr('dy', `${++lineNumber * lineHeight}em`)
                  .text(word);
              }
            }
          });
        }
      }).catch(err => {
        console.error('Error loading data:', err);
        svg.append('text')
          .attr('x', width/2)
          .attr('y', height/2)
          .attr('text-anchor','middle')
          .style('fill','red')
          .text('Unable to load data.');
      });
    });
  </script>
</body>
</html>
